#!/usr/bin/env zsh

# Fitxer de configuració
CONFIG_FILE="${HOME}/.local/bin/items/tuiAppsItems"

# Variables globals
typeset -A APPS_BY_CATEGORY
typeset -a CATEGORIES
VIEW="main"
SELECTED=1
CATEGORY=""
MESSAGE=""

# Control terminal
hide_cursor() { echo -ne "\e[?25l"; }
show_cursor() { echo -ne "\e[?25h"; }
clear_screen() { echo -ne "\e[2J\e[H"; }
move_to() { echo -ne "\e[$1;$2H"; }

# Crear fitxer de configuració per defecte
create_default_config() {
    local dir="${CONFIG_FILE%/*}"
    mkdir -p "$dir"

    cat > "$CONFIG_FILE" << 'EOF'
# Configuració del llançador d'aplicacions
# Format: nom|comanda|tipus|descripció
# Tipus: gui o term

[Internet]
Firefox|firefox|gui|Navegador web ràpid i segur de Mozilla
Chrome|google-chrome|gui|Navegador web de Google amb sincronització al núvol
wget|wget|term|Eina de descàrrega de fitxers des de la línia de comandes

[Desenvolupament]
VS Code|code|gui|Editor de codi modern amb extensions i terminal integrat
Terminal|gnome-terminal|gui|Emulador de terminal de GNOME
vim|vim|term|Editor de text modal potent per a la terminal
htop|htop|term|Monitor interactiu de processos del sistema
EOF
}

# Carregar aplicacions des del fitxer
load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        create_default_config
    fi

    APPS_BY_CATEGORY=()
    CATEGORIES=()

    local current_category=""
    local line

    while IFS= read -r line || [[ -n "$line" ]]; do
        # Eliminar espais al principi i final
        line="${line## }"
        line="${line%% }"

        # Ignorar línies buides i comentaris
        [[ -z "$line" ]] && continue
        [[ "$line" == \#* ]] && continue

        # Detectar categoria
        if [[ "$line" == \[*\] ]]; then
            current_category="${line#\[}"
            current_category="${current_category%\]}"
            CATEGORIES+=("$current_category")
            continue
        fi

        # Afegir aplicació a la categoria actual
        if [[ -n "$current_category" ]]; then
            if [[ -z "${APPS_BY_CATEGORY[$current_category]}" ]]; then
                APPS_BY_CATEGORY[$current_category]="$line"
            else
                APPS_BY_CATEGORY[$current_category]="${APPS_BY_CATEGORY[$current_category]}"$'\n'"$line"
            fi
        fi
    done < "$CONFIG_FILE"
}

# Obtenir llista actual
get_items() {
    if [[ $VIEW == "main" ]]; then
        printf '%s\n' "${CATEGORIES[@]}"
    else
        if [[ -n "${APPS_BY_CATEGORY[$CATEGORY]}" ]]; then
            echo "${APPS_BY_CATEGORY[$CATEGORY]}"
        fi
    fi
}

# Dibuixar quadre
draw_box() {
    local row=$1
    local col=$2
    local width=$3
    local height=$4

    move_to $row $col
    echo -ne "╔${(l:$((width-2))::═:)}╗"

    for ((i=1; i<height-1; i++)); do
        move_to $((row + i)) $col
        echo -ne "║${(l:$((width-2)):: :)}║"
    done

    move_to $((row + height - 1)) $col
    echo -ne "╚${(l:$((width-2))::═:)}╝"
}

# Dibuixar text dins del quadre
draw_text_in_box() {
    local row=$1
    local col=$2
    local width=$3
    local text="$4"

    local max_width=$((width - 4))
    local words=(${(s: :)text})
    local line=""
    local line_num=0

    for word in $words; do
        if [[ ${#line} -eq 0 ]]; then
            line="$word"
        elif [[ $((${#line} + ${#word} + 1)) -le $max_width ]]; then
            line="$line $word"
        else
            move_to $((row + line_num)) $((col + 2))
            echo -ne "$line"
            line="$word"
            ((line_num++))
        fi
    done

    if [[ ${#line} -gt 0 ]]; then
        move_to $((row + line_num)) $((col + 2))
        echo -ne "$line"
    fi
}

# Dibuixar menú
draw() {
    clear_screen
    local w=$(tput cols)
    local h=$(tput lines)

    # Títol
    local title="CATEGORIES"
    [[ $VIEW == "category" ]] && title="$CATEGORY"
    move_to 1 $(( (w - ${#title}) / 2 ))
    echo -ne "\e[1;34m=== $title ===\e[0m"

    # Items
    local -a items
    while IFS= read -r line; do
        [[ -n "$line" ]] && items+=("$line")
    done < <(get_items)

    # Debug info
    if [[ ${#items} -eq 0 ]]; then
        move_to 5 5
        echo -ne "\e[1;31mNo hi ha items per mostrar\e[0m"
        move_to 6 5
        echo -ne "VIEW: $VIEW | CATEGORY: $CATEGORY"
        move_to 7 5
        echo -ne "Categories carregades: ${#CATEGORIES}"
    fi

    local i=1
    for item in "${items[@]}"; do
        [[ $i -gt 15 ]] && break

        local name="${item%%|*}"
        move_to $((i + 3)) 5

        if [[ $i -eq $SELECTED ]]; then
            echo -ne "\e[7;1m► $name\e[0m"
        else
            echo -ne "  $name"
        fi
        ((i++))
    done

    # Quadre de descripció
    if [[ $VIEW == "category" && ${#items} -gt 0 ]]; then
        local selected_item="${items[$SELECTED]}"
        local parts=(${(s:|:)selected_item})
        local desc="${parts[4]}"

        if [[ -n $desc ]]; then
            local box_width=60
            local box_height=6
            local box_row=5
            local box_col=$(( w - box_width - 5 ))

            echo -ne "\e[36m"
            draw_box $box_row $box_col $box_width $box_height
            echo -ne "\e[0m"

            move_to $((box_row + 1)) $((box_col + 2))
            echo -ne "\e[1;33m${parts[1]}\e[0m"

            move_to $((box_row + 2)) $((box_col + 1))
            echo -ne "├${(l:$((box_width-2))::─:)}┤"

            draw_text_in_box $((box_row + 3)) $box_col $box_width "$desc"
        fi
    fi

    # Missatge
    if [[ -n $MESSAGE ]]; then
        move_to $((h - 3)) $(( (w - ${#MESSAGE}) / 2 ))
        echo -ne "\e[1m$MESSAGE\e[0m"
    fi

    # Ajuda
    local help="↑/↓: Navegar | ENTER: "
    [[ $VIEW == "main" ]] && help="${help}Obrir" || help="${help}Executar"
    [[ $VIEW == "category" ]] && help="$help | ESC: Tornar"
    help="$help | e: Editar | q: Sortir"
    move_to $((h - 1)) $(( (w - ${#help}) / 2 ))
    echo -ne "\e[2m$help\e[0m"
}

# Executar aplicació
execute() {
    local -a items
    while IFS= read -r line; do
        [[ -n "$line" ]] && items+=("$line")
    done < <(get_items)

    [[ ${#items} -eq 0 ]] && return

    local item="${items[$SELECTED]}"
    local parts=(${(s:|:)item})
    local name="${parts[1]}"
    local cmd="${parts[2]}"
    local type="${parts[3]}"

    if ! command -v "${cmd%% *}" &>/dev/null; then
        MESSAGE="✗ No s'ha trobat: ${cmd%% *}"
        return
    fi

    if [[ $type == "term" ]]; then
        show_cursor
        clear_screen
        stty echo

        echo "\e[1mExecutant: $name\e[0m"
        echo "─────────────────────"
        eval $cmd
        echo "─────────────────────"
        echo "\nPrem qualsevol tecla..."
        read -k1

        stty -echo
        hide_cursor
        MESSAGE="✓ Executat: $name"
    else
        nohup $cmd &>/dev/null &
        MESSAGE="✓ Iniciat: $name"
    fi
}

# Editar configuració
edit_config() {
    show_cursor
    clear_screen
    stty echo

    ${EDITOR:-nano} "$CONFIG_FILE"

    stty -echo
    hide_cursor

    load_config
    VIEW="main"
    SELECTED=1
    MESSAGE="✓ Configuració recarregada"
}

# Obtenir nombre total d'items
get_total() {
    local count=0
    while IFS= read -r line; do
        [[ -n "$line" ]] && ((count++))
    done < <(get_items)
    echo $count
}

# Neteja i sortida
cleanup() {
    show_cursor
    clear_screen
    stty echo
    exit 0
}

trap cleanup INT TERM EXIT
stty -echo
hide_cursor

# Carregar configuració
load_config

# Bucle principal
while true; do
    draw

    read -k1 key

    if [[ $key == $'\e' ]]; then
        read -k2 rest
        key="$rest"
    fi

    local total=$(get_total)

    case "$key" in
        '[A')
            if [[ $SELECTED -gt 1 ]]; then
                ((SELECTED--))
                MESSAGE=""
            fi
            ;;
        '[B')
            if [[ $SELECTED -lt $total ]]; then
                ((SELECTED++))
                MESSAGE=""
            fi
            ;;
        $'\n')
            if [[ $VIEW == "main" ]]; then
                if [[ $total -gt 0 ]]; then
                    local -a items
                    while IFS= read -r line; do
                        [[ -n "$line" ]] && items+=("$line")
                    done < <(get_items)

                    CATEGORY="${items[$SELECTED]}"
                    VIEW="category"
                    SELECTED=1
                    MESSAGE=""
                fi
            else
                execute
            fi
            ;;
        '[D'|'')
            if [[ $VIEW == "category" ]]; then
                VIEW="main"
                SELECTED=1
                MESSAGE=""
            fi
            ;;
        'e'|'E')
            edit_config
            ;;
        'q'|'Q')
            cleanup
            ;;
    esac
done
